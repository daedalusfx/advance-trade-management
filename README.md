# پنل معاملاتی هیبرید: یک داشبورد حرفه‌ای برای متاتریدر ۵

![تصویری از داشبورد](https://github.com/daedalusfx/advance-trade-management/blob/main/screenshouts/darkmoden.png
)
![تصویری از داشبورد](https://github.com/daedalusfx/advance-trade-management/blob/main/screenshouts/darkmodfa.png)
![تصویری از داشبورد](https://github.com/daedalusfx/advance-trade-management/blob/main/screenshouts/lightmod.png)


یک ابزار مدیریت معامله پیشرفته که قدرت و سرعت اجرای MQL5 را با انعطاف‌پذیری و زیبایی یک رابط کاربری مدرن نوشته‌شده با پایتون ترکیب می‌کند. این پروژه به شما اجازه می‌دهد تا معاملات خود را از طریق یک داشبورد دسکتاپ زیبا و تعاملی، به صورت زنده نظارت و مدیریت کنید.

---

## ✨ ویژگی‌های کلیدی

* **معماری ترکیبی (Hybrid Architecture):** منطق حساس به زمان در MQL5 برای حداکثر سرعت اجرا، و رابط کاربری قدرتمند در پایتون برای بهترین تجربه کاربری.
* **داشبورد زنده:** مشاهده تمام معاملات باز، سود و زیان لحظه‌ای و وضعیت کلی حساب در یک رابط کاربری تمیز و مینیمال.
* **مدیریت خودکار معامله:**
    * **ریسک-فری خودکار (Auto Breakeven):** انتقال اتوماتیک حد ضرر به نقطه ورود بر اساس درصد سود هدف.
    * **خروج بخشی از معامله (Auto Partial Exit):** بستن درصدی از حجم معامله برای ذخیره سود.
* **کنترل کامل دستی:** ارسال دستورات فوری (بستن معامله، بستن همه، بستن سودها/ضررها) از داشبورد پایتون به متاتریدر.
* **تنظیمات پویا:** تغییر و ذخیره قوانین مدیریت خودکار به صورت زنده از طریق داشبورد، بدون نیاز به کامپایل مجدد اکسپرت.
* **ارتباط لحظه‌ای:** استفاده از وب‌سوکت برای آپدیت‌های آنی و بدون تاخیر در داشبورد.

---

## 🏗️ معماری سیستم

این پروژه از یک معماری سه لایه کلاینت-سرور برای دستیابی به بهترین عملکرد و انعطاف‌پذیری استفاده می‌کند:

یک.  **اکسپرت MQL5 (اپراتور هوشمند):**
    * روی متاتریدر ۵ اجرا می‌شود.
    * مسئول اجرای سریع و مستقیم دستورات معاملاتی است.
    * منطق حساس به زمان (مانند `ProcessAutoManagement`) را در خود دارد.
    * داده‌های خام حساب را به سرور ارسال کرده و قوانین و دستورات را از آن دریافت می‌کند.

دو.  **سرور Node.js (پل ارتباطی):**
    * یک سرور سبک و سریع که به عنوان واسطه عمل می‌کند.
    * داده‌های خام را از MQL5 دریافت کرده، به فرمت JSON تبدیل می‌کند و از طریق وب‌سوکت برای داشبورد پایتون پخش می‌کند.
    * دستورات و تنظیمات را از داشبورد پایتون دریافت کرده و برای اکسپرت MQL5 صف می‌کند.

سه.  **داشبورد پایتون (مرکز فرماندهی):**
    * یک اپلیکیشن دسکتاپ که با PyQt6 ساخته شده است.
    * رابط کاربری اصلی شما برای نظارت و مدیریت است.
    * به سرور وب‌سوکت متصل شده و داده‌ها را به صورت زنده نمایش می‌دهد.
    * دستورات و تنظیمات را به سرور ارسال می‌کند.


[داشبورد پایتون (UI)] <--- (WebSocket) ---> [سرور Node.js (API)] <--- (HTTP) ---> [اکسپرت MQL5 (Engine)]


---

## 🛠️ نصب و راه‌اندازی

برای اجرای این سیستم، باید هر سه بخش را به صورت جداگانه راه‌اندازی کنید.

### پیش‌نیازها

* نرم‌افزار **MetaTrader 5**
* **Node.js** (نسخه 14 یا بالاتر)
* **Python** (نسخه 3.8 یا بالاتر)

### مرحله ۱: راه‌اندازی سرور Node.js

1.  وارد پوشه `server` شوید.
2.  پکیج‌های مورد نیاز را با `npm` نصب کنید:
    ```bash
    npm install express ws
    ```
3.  سرور را اجرا کنید:
    ```bash
    node server.js
    ```
    شما باید پیام `🚀 سرور نهایی در حال اجرا است...` را ببینید.

### مرحله ۲: راه‌اندازی اکسپرت MQL5

1.  فایل `hybrid_expert_final.mq5` را در پوشه `MQL5/Experts` در محل نصب متاتریدر خود کپی کنید.
2.  متاتریدر را باز کرده و از منوی `Tools -> Options` به تب `Expert Advisors` بروید.
3.  تیک گزینه **`Allow WebRequest for listed URL`** را فعال کنید.
4.  آدرس `http://127.0.0.1:5000` را به لیست آدرس‌های مجاز اضافه کنید.
5.  اکسپرت را در MetaEditor کامپایل کرده و آن را روی چارت مورد نظر خود اجرا کنید.

### مرحله ۳: راه‌اندازی داشبورد پایتون

1.  وارد پوشه `dashboard` شوید.
2.  پیشنهاد می‌شود یک محیط مجازی (virtual environment) ایجاد کنید:
    ```bash
    python -m venv venv
    source venv/bin/activate  # در لینوکس یا macOS
    venv\Scripts\activate  # در ویندوز
    ```
3.  پکیج‌های مورد نیاز را با `pip` نصب کنید:
    ```bash
    pip install PyQt6 websockets requests
    ```
4.  داشبورد را اجرا کنید:
    ```bash
    python main_app.py
    ```

حالا باید داشبورد شما باز شده و داده‌های زنده را از متاتریدر نمایش دهد.

---

## 🚀 نحوه استفاده

* **نظارت:** به سادگی معاملات باز و سود و زیان کل خود را مشاهده کنید.
* **مدیریت دستی:** از دکمه‌های "بستن"، "بستن همه"، "بستن سودها/ضررها" برای مدیریت سریع معاملات استفاده کنید.
* **مدیریت خودکار:**
    1.  روی دکمه **"تنظیمات"** کلیک کنید.
    2.  قانون مدیریت خودکار خود (درصد تریگر، ریسک-فری و بستن بخشی از حجم) را تعریف و ذخیره کنید.
    3.  مطمئن شوید که دکمه **"خودکار: روشن"** در هدر داشبورد فعال است.
    4.  اکسپرت به صورت خودکار معاملات شما را بر اساس قوانین تعریف‌شده مدیریت خواهد کرد.

---

## 📜 مجوز (License)

این پروژه تحت مجوز **GNU General Public License v3.0** منتشر شده است. برای اطلاعات بیشتر فایل `LICENSE` را مطالعه کنید.

---

## 🤝 مشارکت و ایده‌های آینده

مشارکت شما در توسعه این پروژه باعث افتخار ماست. شما می‌توانید از طریق Pull Request یا ثبت Issue در این پروژه مشارکت کنید.

چند ایده برای توسعه آینده:
* افزودن قابلیت تریلینگ استاپ پیشرفته.
* اضافه کردن داشبورد آمار و عملکرد حساب.
* ساخت نسخه وب یا موبایل برای داشبورد.
* افزودن قابلیت مدیریت ریسک برای حساب‌های پراپ.


## لاگ تغییرات (Changelog)
این نسخه از یک معماری پایدار مبتنی بر **Short Polling HTTP** استفاده می‌کند که در آن اکسپرت با یک مکانیزم صف داخلی، از تداخل در ارسال داده‌ها جلوگیری می‌کند.

---

### [نسخه 2.5.0] - معماری پایدار Polling با مدیریت وضعیت - (تاریخ فعلی)

این نسخه بر پایداری ارتباط، جلوگیری از خرابی داده‌ها و افزودن منطق کامل مدیریت معاملات تمرکز دارد.

---
### اکسپرت (`api.c`)

#### بهبودها (Changed)
- **معماری ارسال داده غیرمسدودکننده:** برای حل مشکل تداخل درخواست‌های وب و خرابی داده‌ها، یک مکانیزم صف داخلی (`g_data_queue`) و پرچم وضعیت (`g_is_sending`) پیاده‌سازی شد. اکسپرت اکنون داده‌ها را در یک صف قرار داده و به صورت کنترل‌شده ارسال می‌کند.
- **مدیریت کامل وضعیت ATM:** منطق کامل برای فعال/غیرفعال کردن مدیریت خودکار برای هر معامله به صورت مجزا (`ToggleAtmForTicket`) پیاده‌سازی شد.
- **انتقال به فرمت JSON:** فرمت تبادل داده با سرور به طور کامل به JSON استاندارد تغییر یافت.

#### ویژگی‌ها (Added)
- **منطق جامع مدیریت خودکار (`ProcessAutoManagement`):** قابلیت‌های پیشرفته‌ای مانند بستن بخشی از حجم، ریسک-فری کردن خودکار و اجرای قوانین بر اساس درصد سود هدف، به اکسپرت اضافه شد.
- **پایداری وضعیت حد ضرر (Stop Loss):** حد ضررهای اولیه معاملات در یک فایل `.dat` ذخیره می‌شوند تا در صورت ری‌استارت شدن اکسپرت، اطلاعات از بین نرود.

#### رفع اشکال (Fixed)
- **رفع باگ `Content-Length`:** مشکل حیاتی که باعث خطای تجزیه JSON در سرور می‌شد، با حذف کاراکتر `\0` از انتهای داده ارسالی به طور کامل حل شد.

---
### سرور (`server.js`)

#### بهبودها (Changed)
- **پشتیبانی کامل از دستورات جدید:** سرور برای دریافت و مدیریت تمام دستورات جدید ارسال شده از داشبورد (مانند `update_settings`, `toggle_auto` و...) به‌روزرسانی شد.
- **دریافت مستقیم JSON:** سرور برای پذیرش مستقیم داده‌های JSON از اکسپرت بهینه شد و دیگر نیازی به تجزیه رشته‌های متنی سفارشی ندارد.

#### ویژگی‌ها (Added)
- **ارتباط دوطرفه با داشبورد:** با استفاده از WebSocket، داده‌های دریافتی از اکسپرت به صورت لحظه‌ای به تمام داشبوردهای متصل ارسال می‌شود.
- **مدیریت تنظیمات:** یک `endpoint` برای دریافت و به‌روزرسانی تنظیمات مدیریت خودکار از طریق داشبورد اضافه شد.

---
### داشبورد پایتون (`app.py`)

*(این لاگ بر اساس فایل‌های قبلی شماست و با این نسخه از اکسپرت و سرور کاملاً هماهنگ است)*

#### بهبودها (Changed)
- **معماری جدول به `Model/View` تغییر یافت:** برای افزایش عملکرد و پایداری، جدول نمایش معاملات بازنویسی شد.
- **استایل‌ها به فایل‌های `.qss` منتقل شدند:** برای خوانایی بهتر، کدهای CSS به فایل‌های خارجی منتقل شدند.

#### رفع اشکال (Fixed)
- **رفع کرش برنامه:** مشکل از کار افتادن برنامه هنگام کلیک روی دکمه "بستن معامله" برطرف شد.
- **افزودن بازخورد خطا:** اکنون در صورت عدم موفقیت در ارسال دستور، کاربر با یک پیغام خطا مطلع می‌شود.